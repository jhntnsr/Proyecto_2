# --- Instalar paquetes ---

install.packages("randomForest")

# --- Ejecutar librerias ---
library(haven)   # Para .sav
library(readxl)  # Para .xlsx
library(dplyr)
library(arules)
library(randomForest)

# --- Función para limpiar nombres de columnas ---
limpiar_nombres <- function(df) {
  # Convertir nombres a minúsculas
  names(df) <- tolower(names(df))
  # Reemplazar caracteres especiales por "_"
  names(df) <- gsub("[^a-z0-9]", "_", names(df))
  return(df)
}

# --- Función para convertir variables labelled a numeric/character ---
convertir_labelled <- function(df) {
  df[] <- lapply(df, function(x) {
    if ("labelled" %in% class(x)) {
      if (is.numeric(x)) as.numeric(x)
      else as.character(x)
    } else x
  })
  df
}

# --- Crear lista de dataframes para divorcios y matrimonios ---
años <- 2009:2024

# Dataframes divorcios
divorcios_list <- lapply(años, function(a) {
  file_ext <- if (a %in% 2023:2024) ".xlsx" else ".sav"
  file_path <- paste0("D:/Documentos/Maestria/Introduccion a la Mineria de Datos/Proyecto_1/Divorcios_", a, file_ext)
  
  df <- if (file_ext == ".sav") read_sav(file_path) else read_excel(file_path)
  df <- limpiar_nombres(df)
  df <- convertir_labelled(df)
  return(df)
})

# Dataframes matrimonios
matrimonios_list <- lapply(años, function(a) {
  file_ext <- if (a %in% 2023:2024) ".xlsx" else ".sav"
  file_path <- paste0("D:/Documentos/Maestria/Introduccion a la Mineria de Datos/Proyecto_1/matrimonios_", a, file_ext)
  
  df <- if (file_ext == ".sav") read_sav(file_path) else read_excel(file_path)
  df <- limpiar_nombres(df)
  df <- convertir_labelled(df)
  return(df)
})

# --- Identificar columnas comunes ---
col_comunes_div <- Reduce(intersect, lapply(divorcios_list, names))
col_comunes_mat <- Reduce(intersect, lapply(matrimonios_list, names))

# --- Filtrar solo columnas comunes ---
divorcios_list <- lapply(divorcios_list, function(df) df[, col_comunes_div, drop = FALSE])
matrimonios_list <- lapply(matrimonios_list, function(df) df[, col_comunes_mat, drop = FALSE])

# --- Combinar todos los años en un solo dataframe ---
d_2009_2024 <- bind_rows(divorcios_list)
m_2009_2024 <- bind_rows(matrimonios_list)

# --- Revisar resultados ---
dim(d_2009_2024)
dim(m_2009_2024)
names(d_2009_2024)
names(m_2009_2024)

# --- Verificar Data Frames ---
data.frame(1:ncol(d_2009_2024), colnames(d_2009_2024))
data.frame(1:ncol(m_2009_2024), colnames(m_2009_2024))

# --- Random Forest Para la Clase de Unión ---

# Selección de columnas
datarfcu <- m_2009_2024[, c("clauni", "nachom", "nacmuj", "edadmuj", "edadhom")]

# Tipos
datarfcu$clauni  <- as.factor(datarfcu$clauni)
datarfcu$nachom  <- as.numeric(datarfcu$nachom)
datarfcu$nacmuj  <- as.numeric(datarfcu$nacmuj)
datarfcu$edadmuj <- as.numeric(datarfcu$edadmuj)
datarfcu$edadhom <- as.numeric(datarfcu$edadhom)

# (Opcional) Reemplazar 999 por NA si aplica
# datarfcu[datarfcu == 999] <- NA

# Quitar NA
datarfcu <- na.omit(datarfcu)

# Mezclar filas
set.seed(50)
datarfcu <- datarfcu[sample(1:nrow(datarfcu)), ]

# Split 80/20
set.seed(50)
indexcu <- sample(1:nrow(datarfcu), size = floor(0.8 * nrow(datarfcu)))
train   <- datarfcu[indexcu, ]
test    <- datarfcu[-indexcu, ]

# Entrenamiento del Random Forest
forestcu <- randomForest(
  clauni ~ nachom + nacmuj + edadmuj + edadhom,
  data  = train,
  ntree = 50,
  mtry  = 4,
  importance = TRUE
)

print(forestcu)

# Predicción en test (clase)
pruebacu <- predict(forestcu, newdata = test, type = "class")
pruebacu

# Matriz de confusión y precisión
matrizcu <- table(Real = test$clauni, Predicho = pruebacu)
matrizcu

precu <- sum(diag(matrizcu)) / sum(matrizcu)
precu

# Predicción de probabilidades para un caso nuevo
clasedu <- data.frame(
  edadmuj = 50,
  edadhom = 60,
  nachom  = 320,
  nacmuj  = 320
)

resultcu <- predict(forestcu, newdata = clasedu, type = "prob")
resultcu


plot(forestcu)



# --- Random Forest para Mes de Ocurrencia (mesocu) ---


# Selección de columnas desde el dataset principal
data_mo <- m_2009_2024[, c("mesocu", "nachom", "nacmuj", "edadmuj", "edadhom")]

data_mo$mesocu  <- as.factor(data_mo$mesocu)

# Predictoras numéricas (ajusta si algunas son factores por diseño)
data_mo$nachom  <- as.numeric(data_mo$nachom)
data_mo$nacmuj  <- as.numeric(data_mo$nacmuj)
data_mo$edadmuj <- as.numeric(data_mo$edadmuj)
data_mo$edadhom <- as.numeric(data_mo$edadhom)

# Mezclar filas para evitar sesgo por orden
set.seed(50)
data_mo <- data_mo[sample(1:nrow(data_mo)), ]

# Split 80/20 (entrenamiento/prueba)
set.seed(50)
index_mo <- sample(1:nrow(data_mo), size = floor(0.8 * nrow(data_mo)))
train_mo <- data_mo[index_mo, ]
test_mo  <- data_mo[-index_mo, ]

# Entrenamiento del Random Forest
forest_mo <- randomForest(
  mesocu ~ edadmuj + edadhom + nachom + nacmuj,
  data  = train_mo,
  ntree = 100,      # puedes subir a 200–500 para más estabilidad
  mtry  = 2,        # sqrt(p) ~ 2 para p=4; prueba 2–3–4
  importance = TRUE
)

print(forest_mo) 

# Predicción en el conjunto de prueba
pred_mo <- predict(forest_mo, newdata = test_mo, type = "class")

# Matriz de confusión y exactitud (accuracy)
conf_mo <- table(Real = test_mo$mesocu, Predicho = pred_mo)
conf_mo

acc_mo <- sum(diag(conf_mo)) / sum(conf_mo)
acc_mo

nuevo_mo <- data.frame(
  edadmuj = 40,
  edadhom = 45,
  nachom  = 320,
  nacmuj  = 320
)

probs_mo <- predict(forest_mo, newdata = nuevo_mo, type = "prob")
probs_mo  # Probabilidad por mes (1–12)

plot(forest_mo)



# --- Random Forest para Departamento de Registro (depreg) ---

data_dr <- m_2009_2024[, c("depreg", "mesreg", "clauni", "depocu")]

data_dr$depreg <- as.factor(data_dr$depreg)

data_dr$mesreg <- as.factor(data_dr$mesreg)
data_dr$clauni <- as.factor(data_dr$clauni)
data_dr$depocu <- as.factor(data_dr$depocu)


# Mezclar filas para evitar sesgo por orden
set.seed(50)
data_dr <- data_dr[sample(1:nrow(data_dr)), ]

# Split 80/20 (entrenamiento/prueba)
set.seed(50)
index_dr <- sample(1:nrow(data_dr), size = floor(0.8 * nrow(data_dr)))
train_dr <- data_dr[index_dr, ]
test_dr  <- data_dr[-index_dr, ]

# Entrenamiento del Random Forest
# Nota: al ser todas las predictoras factores, randomForest construye árboles de clasificación multiclase.
forest_dr <- randomForest(
  depreg ~ mesreg + clauni + depocu,
  data  = train_dr,
  ntree = 200,       # puedes ajustar: 200–500 mejora estabilidad
  mtry  = 2,         # sqrt(p) ≈ 2 para p = 3; prueba también mtry = 3
  importance = TRUE
)

print(forest_dr)

# Predicción en el conjunto de prueba
pred_dr <- predict(forest_dr, newdata = test_dr, type = "class")

# Matriz de confusión y exactitud (accuracy)
conf_dr <- table(Real = test_dr$depreg, Predicho = pred_dr)
conf_dr

acc_dr <- sum(diag(conf_dr)) / sum(conf_dr)
acc_dr

# Probabilidades por clase (opcional)
probs_dr <- predict(forest_dr, newdata = test_dr, type = "prob")
head(probs_dr)


plot(forest_dr)

